============================= test session starts ==============================
platform darwin -- Python 3.12.10, pytest-8.0.2, pluggy-1.5.0 -- /Users/abby/.local/share/mise/installs/python/3.12.10/bin/python3.12
cachedir: .pytest_cache
rootdir: /Users/abby/code/ai_projects/mcp_chat_client/backend
configfile: pytest.ini
plugins: asyncio-0.23.5, anyio-4.9.0, Faker-22.6.0, env-1.1.3, cov-4.1.0, mock-3.12.0, timeout-2.3.1
asyncio: mode=Mode.AUTO
timeout: 300.0s
timeout method: signal
timeout func_only: False
collecting ... collected 29 items

backend/tests/async/test_cache.py::test_cache_operations PASSED          [  3%]
backend/tests/async/test_cache.py::test_cache_key_generation PASSED      [  6%]
backend/tests/async/test_cache.py::test_cache_data_types PASSED          [ 10%]
backend/tests/async/test_cache.py::test_cache_errors PASSED              [ 13%]
backend/tests/async/test_cache.py::test_cache_error_handling PASSED      [ 17%]
backend/tests/async/test_cache.py::test_cache_key_edge_cases PASSED      [ 20%]
backend/tests/async/test_cache.py::test_cache_set_exceptions PASSED      [ 24%]
backend/tests/async/test_model_cache.py::test_generate_cache_key PASSED  [ 27%]
backend/tests/async/test_model_cache.py::test_cache_response_operations PASSED [ 31%]
backend/tests/async/test_model_cache.py::test_error_handling PASSED      [ 34%]
backend/tests/async/test_model_cache.py::test_cache_expiry PASSED        [ 37%]
backend/tests/async/test_monitoring.py::test_record_model_call ERROR     [ 41%]
backend/tests/async/test_monitoring.py::test_record_cache_hit ERROR      [ 44%]
backend/tests/async/test_monitoring.py::test_multiple_users ERROR        [ 48%]
backend/tests/async/test_monitoring.py::test_rate_limiter ERROR          [ 51%]
backend/tests/async/test_monitoring.py::test_telemetry_with_metadata FAILED [ 55%]
backend/tests/async/test_monitoring.py::test_get_user_metrics FAILED     [ 58%]
backend/tests/async/test_monitoring.py::test_get_global_metrics FAILED   [ 62%]
backend/tests/async/test_websocket.py::test_websocket_connection FAILED  [ 65%]
backend/tests/async/test_websocket.py::test_authenticated_connection FAILED [ 68%]
backend/tests/async/test_websocket.py::test_message_sending FAILED       [ 72%]
backend/tests/async/test_websocket.py::test_typing_indicator FAILED      [ 75%]
backend/tests/async/test_websocket.py::test_websocket_status FAILED      [ 79%]
backend/tests/async/test_websocket.py::test_rate_limiting FAILED         [ 82%]
backend/tests/async/test_websocket.py::test_system_message_bypass FAILED [ 86%]
backend/tests/async/test_websocket_rate_limit.py::test_rate_limit_by_ip FAILED [ 89%]
backend/tests/async/test_websocket_rate_limit.py::test_connection_rate_limit FAILED [ 93%]
backend/tests/async/test_websocket_rate_limit.py::test_message_rate_limit FAILED [ 96%]
backend/tests/async/test_websocket_rate_limit.py::test_system_messages_not_rate_limited FAILED [100%]WARNING: Failed to generate report: No data to report.



==================================== ERRORS ====================================
___________________ ERROR at setup of test_record_model_call ___________________
file /Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py, line 19
  @pytest.mark.asyncio
  async def test_record_model_call(
      app: FastAPI,
      client: AsyncClient,
      redis_client: RedisClient
  ) -> None:
      """Test recording a model call with metrics."""
      telemetry = TelemetryService(redis_client)
      user_id = "user1"
      date = datetime.now(UTC).strftime("%Y-%m-%d")

      # Record a model call
      await telemetry.record_model_call(
          user_id=user_id,
          model="gpt-4",
          tokens=150
      )

      # Check user-specific metrics
      user_metrics = await telemetry.get_user_metrics(user_id, date)
      assert user_metrics["model_calls"] == 1
      assert user_metrics["tokens_used"] == 150

      # Check global metrics
      global_metrics = await telemetry.get_global_metrics()
      assert global_metrics["count"] == 1
      assert global_metrics["tokens"] == 150
E       fixture 'app' not found
>       available fixtures: _session_event_loop, _session_faker, anyio_backend, anyio_backend_name, anyio_backend_options, async_redis_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, cov, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, mocker, module_mocker, monkeypatch, no_cover, override_redis_dependency, package_mocker, pytestconfig, rate_limiter, record_property, record_testsuite_property, record_xml_attribute, recwarn, redis_client, session_mocker, test_client, test_settings, tests/async/test_monitoring.py::<event_loop>, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, websocket_manager
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py:19
___________________ ERROR at setup of test_record_cache_hit ____________________
file /Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py, line 47
  @pytest.mark.asyncio
  async def test_record_cache_hit(
      app: FastAPI,
      client: AsyncClient,
      redis_client: RedisClient
  ):
      """Test recording a cache hit with metrics."""
      telemetry = TelemetryService(redis_client)
      user_id = "user1"
      date = datetime.now(UTC).strftime("%Y-%m-%d")

      # Record a cache hit
      await telemetry.record_cache_hit(user_id=user_id)

      # Check user-specific metrics
      user_metrics = await telemetry.get_user_metrics(user_id, date)
      assert user_metrics["cache_hits"] == 1

      # Check global metrics
      global_metrics = await telemetry.get_global_metrics()
      assert global_metrics.get("cache_hits", 0) == 1
E       fixture 'app' not found
>       available fixtures: _session_event_loop, _session_faker, anyio_backend, anyio_backend_name, anyio_backend_options, async_redis_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, cov, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, mocker, module_mocker, monkeypatch, no_cover, override_redis_dependency, package_mocker, pytestconfig, rate_limiter, record_property, record_testsuite_property, record_xml_attribute, recwarn, redis_client, session_mocker, test_client, test_settings, tests/async/test_monitoring.py::<event_loop>, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, websocket_manager
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py:47
____________________ ERROR at setup of test_multiple_users _____________________
file /Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py, line 69
  @pytest.mark.asyncio
  async def test_multiple_users(
      app: FastAPI,
      client: AsyncClient,
      redis_client: RedisClient
  ):
      """Test recording metrics for multiple users."""
      telemetry = TelemetryService(redis_client)
      date = datetime.now(UTC).strftime("%Y-%m-%d")

      # Record calls for user1
      await telemetry.record_model_call(
          user_id="user1",
          model="gpt-4",
          tokens=150
      )
      await telemetry.record_cache_hit("user1")

      # Record calls for user2
      await telemetry.record_model_call(
          user_id="user2",
          model="gpt-4",
          tokens=300
      )
      await telemetry.record_cache_hit("user2")

      # Check user1 metrics
      user1_metrics = await telemetry.get_user_metrics("user1", date)
      assert user1_metrics["model_calls"] == 1
      assert user1_metrics["tokens_used"] == 150
      assert user1_metrics["cache_hits"] == 1

      # Check user2 metrics
      user2_metrics = await telemetry.get_user_metrics("user2", date)
      assert user2_metrics["model_calls"] == 1
      assert user2_metrics["tokens_used"] == 300
      assert user2_metrics["cache_hits"] == 1

      # Check global metrics
      global_metrics = await telemetry.get_global_metrics()
      assert global_metrics["count"] == 2
      assert global_metrics["tokens"] == 450
E       fixture 'app' not found
>       available fixtures: _session_event_loop, _session_faker, anyio_backend, anyio_backend_name, anyio_backend_options, async_redis_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, cov, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, mocker, module_mocker, monkeypatch, no_cover, override_redis_dependency, package_mocker, pytestconfig, rate_limiter, record_property, record_testsuite_property, record_xml_attribute, recwarn, redis_client, session_mocker, test_client, test_settings, tests/async/test_monitoring.py::<event_loop>, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, websocket_manager
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py:69
_____________________ ERROR at setup of test_rate_limiter ______________________
file /Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py, line 112
  @pytest.mark.asyncio
  async def test_rate_limiter(app: FastAPI, client: AsyncClient, redis_client: RedisClient):
      """Test that rate limiting works correctly."""
      requests_per_window = 2
      window_seconds = 1

      # Create rate limiter instance
      limiter = RateLimiter(redis_client, requests_per_window, window_seconds)

      # Set up test route with rate limiting
      @app.get("/api/v1/test/rate_limit")
      async def test_route(request: Request):
          # Check rate limit manually since decorator isn't working in test
          if not await limiter.check_rate_limit(request.headers.get("X-User-Id", "default")):
              return JSONResponse(
                  status_code=status.HTTP_429_TOO_MANY_REQUESTS,
                  content={"error": "Rate limit exceeded", "code": "rate_limit_exceeded"}
              )
          return {"status": "ok"}

      # Make initial requests within limit
      for _ in range(requests_per_window):
          response = await client.get(
              "/api/v1/test/rate_limit",
              headers={"X-User-Id": "test_user"}
          )
          assert response.status_code == 200

      # Next request should be rate limited
      response = await client.get(
          "/api/v1/test/rate_limit",
          headers={"X-User-Id": "test_user"}
      )
      assert response.status_code == 429
E       fixture 'app' not found
>       available fixtures: _session_event_loop, _session_faker, anyio_backend, anyio_backend_name, anyio_backend_options, async_redis_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, class_mocker, cov, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, mocker, module_mocker, monkeypatch, no_cover, override_redis_dependency, package_mocker, pytestconfig, rate_limiter, record_property, record_testsuite_property, record_xml_attribute, recwarn, redis_client, session_mocker, test_client, test_settings, tests/async/test_monitoring.py::<event_loop>, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, websocket_manager
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/abby/code/ai_projects/mcp_chat_client/backend/tests/async/test_monitoring.py:112
=================================== FAILURES ===================================
_________________________ test_telemetry_with_metadata _________________________

redis_client = <tests.helpers.MockRedis object at 0x10d5527e0>

    @pytest.mark.asyncio
    async def test_telemetry_with_metadata(redis_client: RedisClient):
        """Test telemetry with metadata recording."""
        service = TelemetryService(redis_client)
        user_id = "test_user"
        model = "gpt-4"
        tokens = 150
        date = datetime.now(UTC).strftime("%Y-%m-%d")
    
        await service.record_model_call(
            user_id=user_id,
            model=model,
            tokens=tokens
        )
    
        # Check user metrics
        user_metrics = await service.get_user_metrics(user_id, date)
>       assert user_metrics["model_calls"] == 1
E       assert 0 == 1

backend/tests/async/test_monitoring.py:164: AssertionError
----------------------------- Captured stdout call -----------------------------
Error recording model call: 'MockRedisPipeline' object has no attribute 'hincrby'
Error getting user metrics: 'MockRedisPipeline' object has no attribute 'hgetall'
____________________________ test_get_user_metrics _____________________________

redis_client = <tests.helpers.MockRedis object at 0x10d5531a0>

    @pytest.mark.asyncio
    async def test_get_user_metrics(redis_client: RedisClient):
        """Test getting user metrics."""
        service = TelemetryService(redis_client)
        user_id = "test_user"
        model = "gpt-4"
        date = datetime.now(UTC).strftime("%Y-%m-%d")
    
        # Record some activity
        await service.record_model_call(
            user_id=user_id,
            model=model,
            tokens=150
        )
        await service.record_cache_hit(user_id)
    
        # Check metrics
        metrics = await service.get_user_metrics(user_id, date)
>       assert metrics["model_calls"] == 1
E       assert 0 == 1

backend/tests/async/test_monitoring.py:190: AssertionError
----------------------------- Captured stdout call -----------------------------
Error recording model call: 'MockRedisPipeline' object has no attribute 'hincrby'
Error recording cache hit: 'MockRedisPipeline' object has no attribute 'hincrby'
Error getting user metrics: 'MockRedisPipeline' object has no attribute 'hgetall'
___________________________ test_get_global_metrics ____________________________

redis_client = <tests.helpers.MockRedis object at 0x10d5b0470>

    @pytest.mark.asyncio
    async def test_get_global_metrics(redis_client: RedisClient):
        """Test getting global metrics."""
        service = TelemetryService(redis_client)
        model = "gpt-4"
    
        # Record activity for multiple users
        await service.record_model_call(
            user_id="user1",
            model=model,
            tokens=150
        )
        await service.record_cache_hit("user1")
    
        await service.record_model_call(
            user_id="user2",
            model=model,
            tokens=300
        )
        await service.record_cache_hit("user2")
    
        # Check global metrics
        global_metrics = await service.get_global_metrics()
>       assert global_metrics["count"] == 2
E       assert 0 == 2

backend/tests/async/test_monitoring.py:217: AssertionError
----------------------------- Captured stdout call -----------------------------
Error recording model call: 'MockRedisPipeline' object has no attribute 'hincrby'
Error recording cache hit: 'MockRedisPipeline' object has no attribute 'hincrby'
Error recording model call: 'MockRedisPipeline' object has no attribute 'hincrby'
Error recording cache hit: 'MockRedisPipeline' object has no attribute 'hincrby'
Error getting global metrics: 'MockRedisPipeline' object has no attribute 'hgetall'
__________________________ test_websocket_connection ___________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10d5b1ac0>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10d5b0da0>

    def test_websocket_connection(test_client):
>       with test_client.websocket_connect("/api/v1/ws") as ws:

backend/tests/async/test_websocket.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
________________________ test_authenticated_connection _________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10d52ea20>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10d553680>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAxfQ.Ek0vWZLzbiYm9j7rRBuPNk7iVI3_QWrywZm8m1VGFzo'

    def test_authenticated_connection(test_client, auth_token):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
_____________________________ test_message_sending _____________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e5f64e0>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10d902e40>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAxfQ.Ek0vWZLzbiYm9j7rRBuPNk7iVI3_QWrywZm8m1VGFzo'
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10d902090>

    def test_message_sending(test_client, auth_token, websocket_manager):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
---------------------------- Captured stdout setup -----------------------------
[DEBUG] Using MockRedis from: tests.helpers at <class 'tests.helpers.MockRedis'>
____________________________ test_typing_indicator _____________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10d9021b0>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10d5d7b90>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAxfQ.Ek0vWZLzbiYm9j7rRBuPNk7iVI3_QWrywZm8m1VGFzo'

    def test_typing_indicator(test_client, auth_token):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:149: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
____________________________ test_websocket_status _____________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e6141a0>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10d551df0>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAyfQ.U7CosrjTffdZJm_W-3_wccbWyDC3EsjmRJfMHByuPEA'
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10d52df70>

    def test_websocket_status(test_client, auth_token, websocket_manager):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:167: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
---------------------------- Captured stdout setup -----------------------------
[DEBUG] Using MockRedis from: tests.helpers at <class 'tests.helpers.MockRedis'>
______________________________ test_rate_limiting ______________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e576540>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10e616e40>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAyfQ.U7CosrjTffdZJm_W-3_wccbWyDC3EsjmRJfMHByuPEA'
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10e617a40>

    def test_rate_limiting(test_client, auth_token, websocket_manager):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:178: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
---------------------------- Captured stdout setup -----------------------------
[DEBUG] Using MockRedis from: tests.helpers at <class 'tests.helpers.MockRedis'>
__________________________ test_system_message_bypass __________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e5689e0>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10e576780>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzQ1NjgzMjAyfQ.U7CosrjTffdZJm_W-3_wccbWyDC3EsjmRJfMHByuPEA'
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10e5775f0>

    def test_system_message_bypass(test_client, auth_token, websocket_manager):
>       with test_client.websocket_connect(f"{WS_BASE_URL}?token={auth_token}") as websocket:

backend/tests/async/test_websocket.py:204: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
---------------------------- Captured stdout setup -----------------------------
[DEBUG] Using MockRedis from: tests.helpers at <class 'tests.helpers.MockRedis'>
____________________________ test_rate_limit_by_ip _____________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e551d00>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10e5523f0>
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10e552bd0>
rate_limiter = <app.core.websocket_rate_limiter.WebSocketRateLimiter object at 0x10e550980>

    def test_rate_limit_by_ip(test_client, websocket_manager, rate_limiter):
        websocket_manager.rate_limiter = rate_limiter
        # First connection should work
>       with test_client.websocket_connect("/api/v1/ws") as websocket:

backend/tests/async/test_websocket_rate_limit.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
__________________________ test_connection_rate_limit __________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e58ad20>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10e58aa80>
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10e5890a0>
rate_limiter = <app.core.websocket_rate_limiter.WebSocketRateLimiter object at 0x10e5891c0>
test_user = <test_websocket_rate_limit.test_user.<locals>.DummyUser object at 0x10e58a480>
test_settings = Settings(PROJECT_NAME='mcp client chat', DEBUG=False, LOG_LEVEL='INFO', NODE_ENV='development', ENVIRONMENT='test', PO...nyHttpUrl('http://localhost:3000/')], MCP_WEBSOCKET_URL='ws://localhost:8000/ws', MCP_HTTP_URL='http://localhost:8000')

    def test_connection_rate_limit(test_client, websocket_manager, rate_limiter, test_user, test_settings):
        websocket_manager.rate_limiter = rate_limiter
        token = create_access_token(settings=test_settings, data={"sub": str(test_user.id)})
        ws_path_with_token = f"/api/v1/ws?token={token}"
        for _ in range(2):
>           with test_client.websocket_connect(ws_path_with_token) as websocket:

backend/tests/async/test_websocket_rate_limit.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
___________________________ test_message_rate_limit ____________________________

self = <starlette.testclient.WebSocketTestSession object at 0x10e562f30>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10e561af0>
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10e562510>
rate_limiter = <app.core.websocket_rate_limiter.WebSocketRateLimiter object at 0x10e563440>
test_user = <test_websocket_rate_limit.test_user.<locals>.DummyUser object at 0x10e562f00>
test_settings = Settings(PROJECT_NAME='mcp client chat', DEBUG=False, LOG_LEVEL='INFO', NODE_ENV='development', ENVIRONMENT='test', PO...nyHttpUrl('http://localhost:3000/')], MCP_WEBSOCKET_URL='ws://localhost:8000/ws', MCP_HTTP_URL='http://localhost:8000')

    def test_message_rate_limit(test_client, websocket_manager, rate_limiter, test_user, test_settings):
        websocket_manager.rate_limiter = rate_limiter
        token = create_access_token(settings=test_settings, data={"sub": str(test_user.id)})
        ws_path_with_token = f"/api/v1/ws?token={token}"
>       with test_client.websocket_connect(ws_path_with_token) as websocket:

backend/tests/async/test_websocket_rate_limit.py:99: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
____________________ test_system_messages_not_rate_limited _____________________

self = <starlette.testclient.WebSocketTestSession object at 0x10f258f20>

    def __enter__(self) -> WebSocketTestSession:
        with contextlib.ExitStack() as stack:
            self.portal = portal = stack.enter_context(self.portal_factory())
            fut, cs = portal.start_task(self._run)
            stack.callback(fut.result)
            stack.callback(portal.call, cs.cancel)
>           self.send({"type": "websocket.connect"})

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:150: in send
    self.portal.call(self._receive_tx.send, message)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:242: in send
    self.send_nowait(item)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectSendStream(_state=MemoryObjectStreamState(max_buffer_size=inf, buffer=deque([]), open_send_channels=0, open_receive_channels=0, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=True)
item = {'type': 'websocket.connect'}

    def send_nowait(self, item: T_contra) -> None:
        """
        Send an item immediately if it can be done without waiting.
    
        :param item: the item to send
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.BrokenResourceError: if the stream has been closed from the
            receiving end
        :raises ~anyio.WouldBlock: if the buffer is full and there are no tasks waiting
            to receive
    
        """
        if self._closed:
>           raise ClosedResourceError
E           anyio.ClosedResourceError

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/streams/memory.py:211: ClosedResourceError

During handling of the above exception, another exception occurred:

test_client = <starlette.testclient.TestClient object at 0x10f259be0>
websocket_manager = <app.core.websocket.WebSocketManager object at 0x10f25bcb0>
rate_limiter = <app.core.websocket_rate_limiter.WebSocketRateLimiter object at 0x10f25b350>
test_user = <test_websocket_rate_limit.test_user.<locals>.DummyUser object at 0x10f25b110>
test_settings = Settings(PROJECT_NAME='mcp client chat', DEBUG=False, LOG_LEVEL='INFO', NODE_ENV='development', ENVIRONMENT='test', PO...nyHttpUrl('http://localhost:3000/')], MCP_WEBSOCKET_URL='ws://localhost:8000/ws', MCP_HTTP_URL='http://localhost:8000')

    def test_system_messages_not_rate_limited(test_client, websocket_manager, rate_limiter, test_user, test_settings):
        websocket_manager.rate_limiter = rate_limiter
        token = create_access_token(settings=test_settings, data={"sub": str(test_user.id)})
        ws_path_with_token = f"/api/v1/ws?token={token}"
>       with test_client.websocket_connect(ws_path_with_token) as websocket:

backend/tests/async/test_websocket_rate_limit.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:100: in __enter__
    with contextlib.ExitStack() as stack:
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:610: in __exit__
    raise exc_details[1]
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:595: in __exit__
    if cb(*exc_details):
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:478: in _exit_wrapper
    callback(*args, **kwds)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/testclient.py:129: in _run
    await self.app(self.scope, receive_rx.receive, send_tx.send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/errors.py:152: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/base.py:100: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/cors.py:77: in __call__
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:362: in handle
    await self.app(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:95: in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/starlette/routing.py:93: in app
    await func(session)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/routing.py:371: in app
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:634: in solve_dependencies
    solved = await solve_generator(
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/fastapi/dependencies/utils.py:560: in solve_generator
    return await stack.enter_async_context(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:659: in enter_async_context
    result = await _enter(cm)
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/contextlib.py:210: in __aenter__
    return await anext(self.gen)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def get_redis() -> AsyncGenerator[RedisClient, None]:
        """
        Get a Redis client.
    
        Yields:
            RedisClient: The Redis client.
        """
>       client = await get_redis()
E       TypeError: object MockRedis can't be used in 'await' expression

backend/app/api/deps.py:35: TypeError
=============================== warnings summary ===============================
backend/app/core/config.py:16
  /Users/abby/code/ai_projects/mcp_chat_client/backend/app/core/config.py:16: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("LOG_LEVEL", pre=True)

backend/app/core/config.py:27
  /Users/abby/code/ai_projects/mcp_chat_client/backend/app/core/config.py:27: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("POSTGRES_PORT", pre=True)

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /Users/abby/.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

backend/app/db/base_class.py:7
  /Users/abby/code/ai_projects/mcp_chat_client/backend/app/db/base_class.py:7: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /Users/abby/.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../../.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/_pytest/config/__init__.py:1396
  /Users/abby/.local/share/mise/installs/python/3.12.10/lib/python3.12/site-packages/_pytest/config/__init__.py:1396: PytestConfigWarning: Unknown config option: asyncio_fixture_loop_scope
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

tests/async/test_websocket.py::test_authenticated_connection
tests/async/test_websocket.py::test_message_sending
tests/async/test_websocket.py::test_typing_indicator
tests/async/test_websocket.py::test_websocket_status
tests/async/test_websocket.py::test_rate_limiting
tests/async/test_websocket.py::test_system_message_bypass
  /Users/abby/code/ai_projects/mcp_chat_client/backend/app/core/auth.py:66: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + expires_delta

tests/async/test_websocket_rate_limit.py::test_connection_rate_limit
tests/async/test_websocket_rate_limit.py::test_message_rate_limit
tests/async/test_websocket_rate_limit.py::test_system_messages_not_rate_limited
  /Users/abby/code/ai_projects/mcp_chat_client/backend/app/core/auth.py:68: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
- generated xml file: /Users/abby/code/ai_projects/mcp_chat_client/test-reports/junit.xml -

--------- coverage: platform darwin, python 3.12.10-final-0 ----------

FAIL Required test coverage of 80% not reached. Total coverage: 0.00%
=========================== short test summary info ============================
FAILED backend/tests/async/test_monitoring.py::test_telemetry_with_metadata
FAILED backend/tests/async/test_monitoring.py::test_get_user_metrics - assert...
FAILED backend/tests/async/test_monitoring.py::test_get_global_metrics - asse...
FAILED backend/tests/async/test_websocket.py::test_websocket_connection - Typ...
FAILED backend/tests/async/test_websocket.py::test_authenticated_connection
FAILED backend/tests/async/test_websocket.py::test_message_sending - TypeErro...
FAILED backend/tests/async/test_websocket.py::test_typing_indicator - TypeErr...
FAILED backend/tests/async/test_websocket.py::test_websocket_status - TypeErr...
FAILED backend/tests/async/test_websocket.py::test_rate_limiting - TypeError:...
FAILED backend/tests/async/test_websocket.py::test_system_message_bypass - Ty...
FAILED backend/tests/async/test_websocket_rate_limit.py::test_rate_limit_by_ip
FAILED backend/tests/async/test_websocket_rate_limit.py::test_connection_rate_limit
FAILED backend/tests/async/test_websocket_rate_limit.py::test_message_rate_limit
FAILED backend/tests/async/test_websocket_rate_limit.py::test_system_messages_not_rate_limited
ERROR backend/tests/async/test_monitoring.py::test_record_model_call
ERROR backend/tests/async/test_monitoring.py::test_record_cache_hit
ERROR backend/tests/async/test_monitoring.py::test_multiple_users
ERROR backend/tests/async/test_monitoring.py::test_rate_limiter
============= 14 failed, 11 passed, 19 warnings, 4 errors in 3.87s =============
